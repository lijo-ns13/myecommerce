<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Order Status</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .status-badge {
        font-size: 0.9rem;
        padding: 0.4em 0.7em;
        border-radius: 0.4rem;
      }
      .status-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .disabled-info {
        font-size: 0.9rem;
        color: #6c757d;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const currentStatus = "<%= order.status %>";
        const statusSelect = document.getElementById("status");
        const updateBtn = document.getElementById("updateBtn");
        const infoMessage = document.getElementById("infoMessage");

        const statusOptions = Array.from(statusSelect.options);

        const validTransitions = {
          pending: ["processing"],
          processing: ["shipped"],
          shipped: ["delivered"],
          delivered: ["returned"],
          returned: ["refunded"],
          refunded: [],
          cancelled: [],
          out_of_stock: ["pending", "processing"],
          on_hold: ["pending", "processing"],
          failed: ["pending", "processing"],
        };

        let hasNext = false;

        // Disable invalid options and current one
        statusOptions.forEach((option) => {
          const optionValue = option.value;
          if (
            optionValue === currentStatus ||
            !validTransitions[currentStatus].includes(optionValue)
          ) {
            option.disabled = true;
          } else {
            hasNext = true;
          }
        });

        // If there are no valid next statuses, disable update button
        if (!hasNext) {
          statusSelect.disabled = true;
          updateBtn.disabled = true;
          infoMessage.textContent =
            "This order is in a final state. No further status changes are allowed.";
        }
      });
    </script>
  </head>

  <body>
    <div class="container mt-5">
      <div class="card shadow-sm p-4 border-0">
        <h3 class="mb-4 fw-semibold">Edit Order Status</h3>

        <div class="status-container mb-3">
          <span class="fw-medium">Current Status:</span>
          <span
            class="status-badge bg-primary text-white text-capitalize"
            id="currentStatus"><%= order.status %></span>
        </div>

        <form action="/admin/orders/<%= order._id %>" method="POST">
          <div class="mb-4">
            <label for="status" class="form-label fw-medium">Select New
              Status</label>
            <select id="status" name="status" class="form-select">
              <option value="pending" <%=order.status === 'pending' ? 'selected'
                :
                '' %>>Pending</option>
              <option value="processing" <%=order.status === 'processing' ?
                'selected' : '' %>>Processing</option>
              <option value="shipped" <%=order.status === 'shipped' ? 'selected'
                :
                '' %>>Shipped</option>
              <option value="delivered" <%=order.status === 'delivered' ?
                'selected' : '' %>>Delivered</option>
              <option value="cancelled" <%=order.status === 'cancelled' ?
                'selected' : '' %>>Cancelled</option>
              <option value="returned" <%=order.status === 'returned' ?
                'selected'
                : '' %>>Returned</option>
              <option value="refunded" <%=order.status === 'refunded' ?
                'selected'
                : '' %>>Refunded</option>
              <option value="out_of_stock" <%=order.status === 'out_of_stock' ?
                'selected' : '' %>>Out of Stock</option>
              <option value="on_hold" <%=order.status === 'on_hold' ? 'selected'
                :
                '' %>>On Hold</option>
              <option value="failed" <%=order.status === 'failed' ? 'selected' :
                '' %>>Failed</option>
            </select>

            <small id="infoMessage" class="disabled-info d-block mt-2"></small>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" id="updateBtn" class="btn btn-primary px-4">
              Update Status
            </button>
            <a href="/admin/orders" class="btn btn-secondary px-4">Cancel</a>
          </div>
        </form>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
