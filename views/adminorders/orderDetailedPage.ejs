<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Order Detail Page</title>
        <link rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet">
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
            rel="stylesheet">
        <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
        }

        h1,
        h2,
        h3,
        h4,
        h5 {
            margin-bottom: 0.5rem;
        }

        .card {
            border-radius: 10px;
            margin-bottom: 1.5rem;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #007bff;
            color: white;
            border-bottom: none;
        }

        .text-primary {
            font-weight: bold;
        }

        .badge-status {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.9rem;
        }

        .paid {
            background-color: #28a745;
        }

        .pending {
            background-color: #ffc107;
        }

        .progress-bar {
            background-color: #007bff;
        }

        .step-text {
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }

        .order-stage {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .product-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding: 15px 0;
        }

        .product-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 20px;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-info {
            flex: 1;
        }

        .card-body p {
            margin: 0.5rem 0;
        }

        .sidebar {
            height: 100vh;
            width: 250px;
            background-color: #212529;
            color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            border-right: 1px solid #444;
            border-radius: 0 10px 10px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
        }

        .sidebar .nav-link {
            color: #ddd;
            transition: background-color 0.3s, color 0.3s;
            padding: 10px 20px;
        }

        .sidebar .nav-link:hover {
            color: #fff;
            background-color: #495057;
        }

        .sidebar .nav-link.active {
            background-color: #007bff;
            color: #fff;
        }

        .sidebar .p-3 h4 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }

        .btn-custom {
            margin: 0.2rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: static;
                border-right: none;
                box-shadow: none;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }
        body {
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
}

.card {
    border-radius: 12px;
}

.card-header {
    background-color: #007bff;
    color: white;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

.btn-primary {
    background-color: #007bff;
    border: none;
    transition: background-color 0.3s;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    border: none;
    transition: background-color 0.3s;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.badge {
    padding: 0.5em 0.7em;
    border-radius: 20px;
}

.product-item {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: box-shadow 0.3s;
}

.product-item:hover {
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
}

    </style>
    </head>

    <body>

        <div class="sidebar p-3">
            <h4 class="mb-4 text-center">Dashboard</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/dashboard"><i
                            class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/products"><i
                            class="fas fa-box me-2"></i>Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/orders"><i
                            class="fas fa-shopping-cart me-2"></i>Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/category"><i
                            class="fas fa-tags me-2"></i>Category</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/customers"><i
                            class="fas fa-users me-2"></i>Customers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/coupons"><i
                            class="fas fa-ticket-alt me-2"></i>Coupons</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/banners"><i
                            class="fas fa-image me-2"></i>Banners</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/offers"><i
                            class="fas fa-gift me-2"></i>Offers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/inventory"><i
                            class="fas fa-warehouse me-2"></i>Inventory</a>
                </li>
                <li class="nav-item mt-auto">
                    <a class="nav-link text-danger" href="/auth/logout"><i
                            class="fas fa-sign-out-alt me-2"></i>Logout</a>
                </li>
            </ul>
        </div>

        <div class="container mt-5 main-content">
            <!-- Order ID -->
            <div class="text-center mb-4">
                <h2>Order ID: <span class="text-primary fw-bold"><%= order._id
                        %></span></h2>
            </div>

            <!-- Order Summary -->
            <div class="card mb-4 shadow-lg">
                <div
                    class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 text-primary">Total Price: <span
                            class="text-dark">$<%= order.totalPrice.toFixed(2)
                            %></span></h3>
                    <span
                        class="badge <%= order.paymentDetails.paymentMethod === 'Razorpay' && order.paymentDetails.transactionId ? 'bg-success' : 'bg-warning' %>">
                        <%= order.paymentDetails.paymentMethod === 'razorpay' &&
                        order.paymentDetails.transactionId || order.status ===
                        'delivered' ? 'Paid' : 'Not Paid' %>
                    </span>
                </div>
                <div class="card-body">

                    <span
                        class="badge bg-<%= order.status === 'delivered' ? 'success' : order.status === 'shipped' ? 'info' : order.status === 'pending' ? 'warning' : 'secondary' %>">
                        <%= order.status.charAt(0).toUpperCase() +
                        order.status.slice(1) %>
                    </span>

                    <div class="mt-4">
                        <div
                            class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i
                                    class="bi bi-calendar-event me-2 text-primary"></i>
                                <p class="mb-0"><strong>Order Date:</strong>
                                    <span class="text-muted"><%= new
                                        Date(order.orderDate).toLocaleDateString()
                                        %></span></p>
                            </div>
                            <!-- <span class="text-muted"><%= new Date(order.orderDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></span> -->
                        </div>
                        <div
                            class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i
                                    class="bi bi-calendar-check me-2 text-success"></i>
                                <p class="mb-0"><strong>Delivery Date:</strong>
                                    <span class="text-muted"><%= new
                                        Date(order.deliveryDate).toLocaleDateString()
                                        %></span></p>
                            </div>
                            <!-- <span class="text-muted"><%= new Date(order.deliveryDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></span> -->
                        </div>
                    </div>

                    <!-- Payment Details -->
                    <h4 class="text-secondary mt-3">Payment Details:</h4>
                    <p class="mb-1"><strong>Payment Method:</strong> <span
                            class="text-muted"><%=
                            order.paymentDetails.paymentMethod %></span></p>
                    <p class="mb-1"><strong>Transaction ID:</strong> <span
                            class="text-muted"><%=
                            order.paymentDetails.transactionId || 'N/A'
                            %></span></p>

                    <!-- Shipping Address -->
                    <h4 class="text-secondary mt-3">Shipping Address:</h4>
                    <div class="p-3 border rounded bg-light"
                        style="border: 1px solid #dee2e6;">
                        <p class="mb-1"><i class="bi bi-geo-alt-fill"></i>
                            <strong>Phone No:</strong> <span
                                class="text-muted"><%=
                                order.shippingAddress.phoneNo %></span></p>
                        <p class="mb-1"><i class="bi bi-house-fill"></i>
                            <strong>Street:</strong> <span
                                class="text-muted"><%=
                                order.shippingAddress.street %></span></p>
                        <p class="mb-1"><i class="bi bi-building"></i>
                            <strong>City:</strong> <span class="text-muted"><%=
                                order.shippingAddress.city %></span></p>
                        <p class="mb-1"><i class="bi bi-map"></i>
                            <strong>State:</strong> <span class="text-muted"><%=
                                order.shippingAddress.state %></span></p>
                        <p class="mb-1"><i class="bi bi-code-slash"></i>
                            <strong>Zip Code:</strong> <span
                                class="text-muted"><%= order.shippingAddress.zip
                                %></span></p>
                        <p class="mb-1"><i class="bi bi-globe"></i>
                            <strong>Country:</strong> <span
                                class="text-muted"><%=
                                order.shippingAddress.country %></span></p>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-lg">
                <div class="card-header">
                    <h2 class="mb-0">Edit Order Status</h2>
                </div>
                <%if(order.status==='pending_return'){%>
                <h4>Return reason:<%=order.returnReason%></h4>
                <%}%>
                <div class="card-body">
                    <form action="/admin/orders/<%= order._id %>/edit"
                        method="POST">
                        <div class="mb-3">
                            <label for="status" class="form-label">Order
                                Status</label>
                            <select id="status" name="status"
                                class="form-select">
                                <option value="pending" <%=order.status ===
                                    'pending' ? 'selected' : ''
                                    %>>Pending</option>
                                <option value="processing" <%=order.status ===
                                    'processing' ? 'selected' : ''
                                    %>>Processing</option>
                                <option value="shipped" <%=order.status ===
                                    'shipped' ? 'selected' : ''
                                    %>>Shipped</option>
                                <option value="delivered" <%=order.status ===
                                    'delivered' ? 'selected' : '' %>
                                    disabled>Delivered</option>
                                <option value="pending_return" <%=order.status
                                    === 'pending_return' ? 'selected' : ''
                                    %>>Return Pending</option>
                                <option value="processing_return"
                                    <%=order.status === 'processing_return' ?
                                    'selected' : '' %>>Return
                                    Processing</option>
                                <option value="initiated_return" <%=order.status
                                    === 'initiated_return' ? 'selected' : ''
                                    %>>Return Initiated</option>
                                <option value="returned" <%=order.status ===
                                    'returned' ? 'selected' : '' %>
                                    disabled>Returned</option>
                                <option value="refunded" <%=order.status ===
                                    'refunded' ? 'selected' : '' %>
                                    disabled>Refunded</option>
                                <option value="cancelled" <%=order.status ===
                                    'cancelled' ? 'selected' : ''
                                    %>>Cancelled</option>

                                <option value="rejected_return" <%=order.status
                                    ===
                                    'rejected_return' ? 'selected' : ''
                                    %>>rejected_return</option>
                                <option value="out_of_stock" <%=order.status ===
                                    'out_of_stock' ? 'selected' : '' %>>Out of
                                    Stock</option>
                                <option value="on_hold" <%=order.status ===
                                    'on_hold' ? 'selected' : '' %>>On
                                    Hold</option>
                                <option value="payment_failed" <%=order.status
                                    ===
                                    'payment_failed' ? 'selected' : ''
                                    %>>Payment Failed</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="btn btn-primary me-2">Update Status</button>
                        <a href="/admin/orders"
                            class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>

            <!-- Order Details -->
            <div class="card shadow-lg">
                <div class="card-header">
                    <h3>Order Details</h3>
                </div>
                <div class="card-body">

                    <%for(const productDetail of order.orderedProducts){%>
                    <div class="row">
                        <div class="col-md-3">
                            <img src="<%=productDetail.productImage%>" alt
                                class="img-fluid img-thumbnail"
                                alt="<%=productDetail.productImage%>">
                        </div>
                        <div class="col-md-3">
                            <h5><%= productDetail.productName %></h5>
                            <p>Size: <%= productDetail.productSize %></p>
                            <p>Quantity: <%= productDetail.productQuantity%></p>
                            <p>Price per unit: $<%= productDetail.productPrice
                                %></p>
                            <p><strong>Subtotal: $<%= productDetail.productPrice
                                    * productDetail.productQuantity %></p>
                            </div>
                        </div>
                        <%}%>

                    </div>
                </div>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const currentStatus = "<%= order.status %>";
                    const statusSelect = document.getElementById("status");
                    const statusOptions = Array.from(statusSelect.options);
                
                    // Define the allowed transitions
                    const validTransitions = {
                        "pending": ["processing"],
                        "processing": ["shipped"],
                        "shipped": ["delivered"],
                        "delivered": [], // Admin cannot change this status
                        "cancelled": [], // Admin cannot change this status
                        "pending_return":['processing_return','rejected_return'],
                        "processing_return":["initiated_return",'rejected_return'],
                        "initiated_return":["returned",'rejected_return'],
                        "rejected_return":[],
                        "returned": ["refunded"], // Admin cannot change this status
                        "refunded": [], // Admin cannot change this status
                        "out_of_stock": ["pending", "processing"],
                        "on_hold": ["pending", "processing"],
                        "payment_failed": []
                    };
                    
                    // Disable invalid options based on current status
                   // Disable invalid options based on current status
statusOptions.forEach(option => {
    const isCurrentStatus = option.value === currentStatus;
    const isValidTransition = validTransitions[currentStatus].includes(option.value);

    // Disable the option if it's not the current status and not a valid transition
    option.disabled = !isCurrentStatus && !isValidTransition;

    // Additional logic for certain statuses that should not allow further changes
    if (['delivered', 'cancelled', 'refunded'].includes(currentStatus)) {
        option.disabled = true; // No changes allowed once these statuses are reached
    }
});

                });
            </script>

            <script
                src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
            <script
                src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
            <script
                src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        </body>

    </html>
