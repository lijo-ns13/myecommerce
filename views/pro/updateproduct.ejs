
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Product</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 20px;
        }
        .form-group img {
            max-width: 150px;
            margin-bottom: 10px;
        }
        .existing-images img {
            margin-right: 10px;
        }
        .img-preview {
            max-width: 100%;
            margin: 20px 0;
        }
        #cropModal .modal-body {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #cropModal img {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Update Product</h1>
        <form id="updateProductForm" action="/admin/products/update/<%= product._id %>" method="POST" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="productName">Product Name</label>
                    <input type="text" class="form-control" id="productName" name="name" value="<%= product.name %>" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="brand">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand" value="<%= product.brand %>" required>
                </div>
            </div>
            <!-- Other fields... -->

            <div class="form-group">
                <label for="productImages">Upload New Images</label>
                <input type="file" class="form-control-file" id="productImages" accept="image/*">
                <small class="form-text text-muted">You can upload up to 5 images. Images will be cropped before upload.</small>
            </div>

            <div class="form-group">
                <label>Existing Images</label>
                <div class="existing-images">
                    <% if (product.images && product.images.length > 0) { %>
                        <% product.images.forEach(image => { %>
                            <img src="<%= image %>" alt="Product Image" class="img-thumbnail">
                        <% }) %>
                    <% } else { %>
                        <p>No images available for this product.</p>
                    <% } %>
                </div>
            </div>

            <div id="croppedImagesContainer"></div>
            
            <button type="submit" class="btn btn-primary">Update Product</button>
        </form>
    </div>

    <!-- Cropper Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="cropImage" src="" alt="Crop Image">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="cropBtn" class="btn btn-primary">Crop & Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let cropper;
        let croppedImages = [];

        // Handle file selection and open modal for cropping
        document.getElementById('productImages').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cropImage').src = e.target.result;
                    $('#cropModal').modal('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Initialize Cropper on modal show
        $('#cropModal').on('shown.bs.modal', function () {
            const image = document.getElementById('cropImage');
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                preview: '.img-preview'
            });
        });

        // Destroy cropper instance on modal hide
        $('#cropModal').on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });

        // Handle crop button click
        document.getElementById('cropBtn').addEventListener('click', function() {
            const canvas = cropper.getCroppedCanvas();
            canvas.toBlob(function(blob) {
                const croppedImageURL = URL.createObjectURL(blob);
                
                // Show the cropped image in the form
                const imgElement = document.createElement('img');
                imgElement.src = croppedImageURL;
                imgElement.classList.add('img-thumbnail');
                document.getElementById('croppedImagesContainer').appendChild(imgElement);
                
                // Append the cropped image as a file in the form data
                const croppedFile = new File([blob], 'cropped_image.jpg', { type: 'image/jpeg' });
                croppedImages.push(croppedFile);
                
                $('#cropModal').modal('hide');
            });
        });

        // Handle form submission
        document.getElementById('updateProductForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            croppedImages.forEach((image, index) => {
                formData.append(`croppedImages[${index}]`, image);
            });

            // Submit the form using AJAX or update the action to handle file upload in the backend
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle success or error
                console.log('Success:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
