<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.product %> - Product Detail</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
        }

        .product-detail {
            margin-top: 20px;
        }

        .product-detail img {
            max-width: 100%;
            height: auto;
        }

        .product-info {
            margin-top: 20px;
        }

        .product-title {
            font-size: 2rem;
            font-weight: bold;
        }

        .product-price {
            font-size: 1.5rem;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }

        .product-rating {
            color: #FFD700;
            margin-top: 10px;
        }

        .product-description {
            font-size: 1.1rem;
            color: #555;
            margin-top: 10px;
        }

        .btn-custom {
            margin-top: 10px;
            font-size: 1.2rem;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
        }

        .reviews-section {
            margin-top: 40px;
        }

        .review-title {
            font-weight: bold;
            font-size: 1.4rem;
        }

        .review-content {
            font-size: 1rem;
            margin-top: 5px;
            color: #555;
        }

        .form-control.custom-select {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            padding: .5rem 1rem;
        }

        .size-buttons {
            margin-top: 10px;
        }

        .size-buttons button {
            margin: 5px;
            font-size: 1rem;
        }
        /* related */
        .product-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .product-box {
            text-decoration: none; /* Remove underline from links */
            color: inherit; /* Inherit text color */
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            max-width: 300px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .product-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .product-images {
            position: relative;
            height: 200px;
            overflow: hidden;
        }
        .product-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .product-images img.active {
            opacity: 1;
        }
        .product-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }
        .product-details {
            margin-bottom: 15px;
            text-align: center;
        }
        .original-price {
            text-decoration: line-through;
            color: #6c757d;
            margin-right: 10px;
        }
        .final-price {
            font-size: 1.5rem;
            color: #ff5252;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn-love {
            color: #6c757d;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .btn-love.liked {
            color: red;
        }
        .btn-view-more {
            margin-top: 10px;
        }
        .badge {
            display: block;
            margin-top: 10px;
        }
        .stock-quantity {
            margin-top: 5px;
            color: #28a745; /* Green for in-stock items */
        }
        .btn-wishlist {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
}

.btn-wishlist.added {
    color: red; /* Change to your preferred color */
}

.wishlist-feedback {
    margin-top: 5px;
    font-size: 14px;
    color: green; /* Color for success message */
    opacity: 1;
    transition: opacity 0.3s ease;
}

        .btn-love.liked {
            color: red;
        }
        .btn-view-more {
            margin-top: 10px;
        }
        .badge {
            display: block;
            margin-top: 10px;
        }
        .stock-quantity {
            margin-top: 5px;
            color: #28a745; /* Green for in-stock items */
        }
        .product-title {
    font-size: 2em;
    font-weight: bold;
    margin-bottom: 10px;
}

.product-price {
    font-size: 1.5em;
    margin-bottom: 10px;
}

.original-price {
    text-decoration: line-through;
    color: #999;
}

.final-price {
    color: #e63946;
    font-weight: bold;
}


/* Ensure the colors align with your design */
.text-danger {
    color: red; /* Color for liked items */
}

.text-muted {
    color: gray; /* Color for not liked items */
}

    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
</head>

<body>
    
    <%- include('partials/nav')%>
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/category/<%= product.category %>"><%= product.category.name %></a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <%= product.product %>
                </li>
            </ol>
        </nav>
        
        <!-- Product Detail Section -->
        <div class="product-detail row">
            <div class="col-md-6">
                <!-- Product Image Carousel -->
                <div id="productCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        <% product.images.forEach((image, index) => { %>
                            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                <img src="<%= image.secured_url %>" 
                                     alt="<%= product.product %>" 
                                     data-zoom-image="<%= image.secured_url %>" 
                                     class="d-block w-100 product-zoom"
                                     style="width: 300px; height: auto;">
                            </div>
                            
                        <% }) %>
                    </div>

                    <!-- Controls -->
                    <a class="carousel-control-prev" href="#productCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#productCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="col-md-6 product-info">
                <!-- Product Info Section -->
                 <!-- Product Info Section -->
                <h1 class="product-title"><%= product.product %></h1>
                            
                <% if(isOffer) { %>
                    <p class="product-price original-price">$<%= product.price.toFixed(2) %></p>
                    <p class="product-price final-price">$<%= product.finalPrice.toFixed(2) %></p>
                <% } else { %>
                    <p class="product-price final-price">$<%= product.finalPrice.toFixed(2) %></p>
                <% } %>

                
                <div class="product-rating">
                    <% for (let i = 1; i <= 5; i++) { %>
                        <% if (i <= product.rating) { %>
                            <span>&#9733;</span> <!-- Filled star -->
                        <% } else { %>
                            <span>&#9734;</span> <!-- Empty star -->
                        <% } %>
                    <% } %>
                    (<%= product.rating %> / 5)
                </div>
                <div class="size-selection mt-3">
                    <label for="sizeSelect">Select Size:</label>
                    <% if (product.sizes.length > 0) { %>
                        <div class="size-buttons">
                            <% product.sizes.forEach(size => { %>
                                <button type="button" class="btn btn-outline-primary size-button" data-size="<%= size.size %>"><%= size.size %></button>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p>No sizes available</p>
                    <% } %>
                </div>
                <p class="product-description"><%= product.description %></p>

                <!-- Add to Cart Button -->
                <form id="addToCartForm">
                    <input type="hidden" name="productId" value="<%= product._id %>">
                    <input type="hidden" name="size" id="selectedSize">
                    <button type="submit" class="btn btn-success btn-custom">Add to Cart</button>
                </form>

                <!-- Add to Wishlist Button -->
                <!-- <form action="/user/wishlist/add/<%=product._id%>" method="POST" class="mt-2">
                    <input type="hidden" name="productId" value="<%= product.id %>">
                    <button type="submit" class="btn btn-outline-danger btn-custom">Add to Wishlist</button>
                </form> -->
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <h2 class="review-title">Customer Reviews</h2>

            <% product.reviews.forEach(review => { %>
                <div class="review">
                    <div class="review-title"><%= review.user %></div>
                    <div class="product-rating">
                        <% for (let i = 1; i <= 5; i++) { %>
                            <% if (i <= review.rating) { %>
                                <span>&#9733;</span> <!-- Filled star -->
                            <% } else { %>
                                <span>&#9734;</span> <!-- Empty star -->
                            <% } %>
                        <% } %>
                    </div>
                    <p class="review-content"><%= review.content %></p>
                </div>
                <hr>
            <% }) %>

            <% if (product.reviews.length === 0) { %>
                <p>No reviews yet. Be the first to review this product!</p>
            <% } %>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="related-products-section">
        
        <div class="container">
            <h2 class="mt-5">Related Products</h2>
            <div class="row">
                <div class="product-grid">
                    <% for (const product of relatedProducts) { %>
                        <a href="/product-detail/<%= product._id %>" class="product-box">
                            <div class="product-images" onmouseover="startSlideshow(this)" onmouseout="stopSlideshow(this)">
                                <% for (const image of product.images) { %>
                                    <img src="<%= image.secured_url %>" alt="Product Image" class="<%= image === product.images[0] ? 'active' : '' %>">
                                <% } %>
                            </div>
                            <div class="product-title mt-2">
                                <%= product.product %>
                            </div>
                            <div class="product-details text-center mt-2">
                                <p class="rating">
                                    <% for (let i = 0; i < 5; i++) { %>
                                        <i class="fas fa-star <%= i < product.rating ? 'text-warning' : 'text-muted' %>"></i>
                                    <% } %>
                                </p>
                                <% if (product.offerApplied) { %>
                                    <p>
                                        <span class="original-price">$<%= product.price.toFixed(2) %></span>
                                        <span class="final-price">$<%= product.finalPrice.toFixed(2) %></span>
                                        <span class="discount-percentage" style="color: red; font-weight: bold;">
                                            <% 
                                                const discountPercentage = ((product.price - product.finalPrice) / product.price) * 100; 
                                            %>
                                            <%= discountPercentage.toFixed(0) %>% off
                                        </span>
                                    </p>
                                <% } else { %>
                                    <p class="final-price">$<%= product.price.toFixed(2) %></p>
                                <% } %>
                                <span class="badge <%= product.sizes.some(size => size.stock > 0) ? 'badge-success' : 'badge-danger' %>">
                                    <%= product.sizes.some(size => size.stock > 0) ? 'In Stock' : 'Out of Stock' %>
                                </span>
                            </div>
                            <form action="/user/wishlist/<%= product.inWishlist ? 'remove' : 'add' %>/<%= product._id %>" method="POST" class="wishlist-form">
                                <button class="btn btn-love <%= product.inWishlist ? 'liked' : 'not-liked' %>" type="submit" style="border: none; background: transparent;">
                                    <i class="fas fa-heart <%= product.inWishlist ? 'text-danger' : 'text-muted' %>"></i>
                                </button>
                            </form>
                            
                            
                            
                        </a>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Initialize image zoom
        $('.product-zoom').elevateZoom();

        // Handle size selection
        let selectedSize = null;
        $('.size-button').on('click', function() {
            selectedSize = $(this).data('size');
            $('#selectedSize').val(selectedSize);
            $('.size-button').removeClass('btn-primary').addClass('btn-outline-primary');
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
        });

    // Add to cart logic
// Add to cart logic
$('#addToCartForm').on('submit', function(e) {
    e.preventDefault();

    // Check if a size is selected
    if (!selectedSize) {
        Swal.fire({
            icon: 'warning',
            title: 'Size Required',
            text: 'Please select a size before adding the product to your cart.',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Fetch API to submit form data
    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            productId: $('input[name="productId"]').val(),
            size: selectedSize
        })
    })
    .then(response => {
        if (response.status === 401) { // Unauthorized
            return response.text().then(text => {
                Swal.fire({
                    icon: 'warning',
                    title: 'Unauthorized',
                    text: 'You need to log in to add items to the cart.',
                    confirmButtonText: 'Login',
                    onClose: () => {
                        window.location.href = '/auth/signin'; // Redirect to login page
                    }
                });
            });
        } else if (response.ok) { // Check if the response is ok (status code in the range 200-299)
            return response.json().then(data => {
                // Ensure data is an object with the expected properties
                if (data && typeof data === 'object') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Added to Cart',
                        text: data.message || 'Item added to cart successfully.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error('Unexpected response format.');
                }
            });
        } 
        else if(response.status===403){
            return response.json().then(data => {
                // Ensure data is an object with the expected properties
                if (data && typeof data === 'object') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'limit',
                        text: data.message || 'error occured.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error('Unexpected response format.');
                }
            });
        }
        else {
            return response.text().then(text => {
                throw new Error(text || 'Something went wrong');
            });
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'There was a problem adding the product to your cart. Please try again later.',
            confirmButtonText: 'OK'
        });
    });
});

    </script>
    
</body>

</html>
