<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.product %> - Product Detail</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
        }

        .product-detail {
            margin-top: 20px;
        }

        .product-detail img {
            max-width: 100%;
            height: auto;
        }

        .product-info {
            margin-top: 20px;
        }

        .product-title {
            font-size: 2rem;
            font-weight: bold;
        }

        .product-price {
            font-size: 1.5rem;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }

        .product-rating {
            color: #FFD700;
            margin-top: 10px;
        }

        .product-description {
            font-size: 1.1rem;
            color: #555;
            margin-top: 10px;
        }

        .btn-custom {
            margin-top: 10px;
            font-size: 1.2rem;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
        }

        .reviews-section {
            margin-top: 40px;
        }

        .review-title {
            font-weight: bold;
            font-size: 1.4rem;
        }

        .review-content {
            font-size: 1rem;
            margin-top: 5px;
            color: #555;
        }

        .form-control.custom-select {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            padding: .5rem 1rem;
        }

        .size-buttons {
            margin-top: 10px;
        }

        .size-buttons button {
            margin: 5px;
            font-size: 1rem;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
</head>

<body>
    
    <%- include('partials/nav')%>
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/category/<%= product.category %>"><%= product.category %></a></li>
                <li class="breadcrumb-item active" aria-current="page"><%= product.product %></li>
            </ol>
        </nav>

        <!-- Product Detail Section -->
        <div class="product-detail row">
            <div class="col-md-6">
                <!-- Product Image Carousel -->
                <div id="productCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        <% product.images.forEach((image, index) => { %>
                            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                <img src="<%= image.secured_url %>" 
                                     alt="<%= product.product %>" 
                                     data-zoom-image="<%= image.secured_url %>" 
                                     class="d-block w-100">
                            </div>
                        <% }) %>
                    </div>

                    <!-- Controls -->
                    <a class="carousel-control-prev" href="#productCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#productCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="col-md-6 product-info">
                <!-- Product Info Section -->
                <h1 class="product-title"><%= product.product %></h1>
                <p class="product-price">$<%= product.price %></p>
                <div class="product-rating">
                    <% for (let i = 1; i <= 5; i++) { %>
                        <% if (i <= product.rating) { %>
                            <span>&#9733;</span> <!-- Filled star -->
                        <% } else { %>
                            <span>&#9734;</span> <!-- Empty star -->
                        <% } %>
                    <% } %>
                    (<%= product.rating %> / 5)
                </div>
                <div class="size-selection mt-3">
                    <label for="sizeSelect">Select Size:</label>
                    <% if (product.sizes.length > 0) { %>
                        <div class="size-buttons">
                            <% product.sizes.forEach(size => { %>
                                <button type="button" class="btn btn-outline-primary size-button" data-size="<%= size.size %>"><%= size.size %></button>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p>No sizes available</p>
                    <% } %>
                </div>
                <p class="product-description"><%= product.description %></p>

                <!-- Add to Cart Button -->
                <form id="addToCartForm">
                    <input type="hidden" name="productId" value="<%= product.id %>">
                    <input type="hidden" name="size" id="selectedSize">
                    <button type="submit" class="btn btn-success btn-custom">Add to Cart</button>
                </form>

                <!-- Add to Wishlist Button -->
                <form action="/add-to-wishlist" method="POST" class="mt-2">
                    <input type="hidden" name="productId" value="<%= product.id %>">
                    <button type="submit" class="btn btn-outline-danger btn-custom">Add to Wishlist</button>
                </form>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <h2 class="review-title">Customer Reviews</h2>

            <% product.reviews.forEach(review => { %>
                <div class="review">
                    <div class="review-title"><%= review.user %></div>
                    <div class="product-rating">
                        <% for (let i = 1; i <= 5; i++) { %>
                            <% if (i <= review.rating) { %>
                                <span>&#9733;</span> <!-- Filled star -->
                            <% } else { %>
                                <span>&#9734;</span> <!-- Empty star -->
                            <% } %>
                        <% } %>
                    </div>
                    <p class="review-content"><%= review.content %></p>
                </div>
                <hr>
            <% }) %>

            <% if (product.reviews.length === 0) { %>
                <p>No reviews yet. Be the first to review this product!</p>
            <% } %>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="related-products-section">
        <h2 class="mt-5">Related Products</h2>
        <div class="container">
            <div class="row">
                <% for (const relatedProduct of relatedProducts) { %>
                    <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
                        <div class="card h-100">
                            <!-- Product Image -->
                            <a href="/product-detail/<%= relatedProduct._id %>">
                                <img src="<%= relatedProduct.images[0].secured_url %>" alt="Product Image" class="card-img-top">
                            </a>
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="/product-detail/<%= relatedProduct._id %>" class="text-dark"><%= relatedProduct.product %></a>
                                </h5>
                                <p class="card-text">
                                    <span class="text-warning">
                                        <%= relatedProduct.rating %> <i class="fas fa-star"></i>
                                    </span>
                                    <span class="text-muted float-right">$<%= relatedProduct.price %></span>
                                </p>
                            </div>

                            <!-- Bottom Buttons -->
                            <div class="card-footer bg-transparent border-0">
                                <form action="/cart/add" method="POST">
                                    <input type="hidden" name="productId" value="<%= relatedProduct._id %>">
                                    <button type="submit" class="btn btn-success btn-custom">Add to Cart</button>
                                </form>
                                <form action="/user/wishlist/add" method="POST" class="wishlist-form">
                                    <input type="hidden" name="productId" value="<%= relatedProduct._id %>">
                                    <button class="btn btn-outline-danger btn-block" type="submit">
                                        <i class="fas fa-heart"></i> Add to Wishlist
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Initialize image zoom
        $('img[data-zoom-image]').elevateZoom();

        // Handle size selection
        let selectedSize = null;
        $('.size-button').on('click', function() {
            selectedSize = $(this).data('size');
            $('#selectedSize').val(selectedSize);
            $('.size-button').removeClass('btn-primary').addClass('btn-outline-primary');
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
        });

    // Add to cart logic
// Add to cart logic
$('#addToCartForm').on('submit', function(e) {
    e.preventDefault();

    // Check if a size is selected
    if (!selectedSize) {
        Swal.fire({
            icon: 'warning',
            title: 'Size Required',
            text: 'Please select a size before adding the product to your cart.',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Fetch API to submit form data
    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            productId: $('input[name="productId"]').val(),
            size: selectedSize
        })
    })
    .then(response => {
        if (response.status === 401) { // Unauthorized
            return response.text().then(text => {
                Swal.fire({
                    icon: 'warning',
                    title: 'Unauthorized',
                    text: 'You need to log in to add items to the cart.',
                    confirmButtonText: 'Login',
                    onClose: () => {
                        window.location.href = '/auth/signin'; // Redirect to login page
                    }
                });
            });
        } else if (response.ok) { // Check if the response is ok (status code in the range 200-299)
            return response.json().then(data => {
                // Ensure data is an object with the expected properties
                if (data && typeof data === 'object') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Added to Cart',
                        text: data.message || 'Item added to cart successfully.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error('Unexpected response format.');
                }
            });
        } 
        else if(response.status===403){
            return response.json().then(data => {
                // Ensure data is an object with the expected properties
                if (data && typeof data === 'object') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'limit',
                        text: data.message || 'error occured.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error('Unexpected response format.');
                }
            });
        }
        else {
            return response.text().then(text => {
                throw new Error(text || 'Something went wrong');
            });
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'There was a problem adding the product to your cart. Please try again later.',
            confirmButtonText: 'OK'
        });
    });
});

    </script>
    
</body>

</html>
